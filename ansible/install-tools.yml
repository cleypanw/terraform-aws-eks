- name: Install and configure awscli, kubectl, create ns and deploy ArgoCD
  hosts: "{{ target | default('nothing') }}"
  become: true

  vars:
    ansible_user: ubuntu
    ansible_venv_path: /opt/ansible-venv

  environment:
    AWS_ACCESS_KEY_ID: "{{ AWS_ACCESS_KEY_ID }}"
    AWS_SECRET_ACCESS_KEY: "{{ AWS_SECRET_ACCESS_KEY }}"
    AWS_DEFAULT_REGION: "{{ AWS_DEFAULT_REGION }}"
    EKS_CLUSTER_NAME: "{{ EKS_CLUSTER_NAME }}"

  tasks:

    # ---------------- System ----------------
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install base tools
      ansible.builtin.apt:
        name:
          - python3-pip
          - python3-venv
          - jq
          - unzip
          - curl
          - ca-certificates
        state: present

    # ---------------- AWS CLI v2 ----------------
    - name: Download AWS CLI v2
      ansible.builtin.get_url:
        url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
        dest: /tmp/awscliv2.zip
        mode: '0644'

    - name: Unzip AWS CLI installer
      ansible.builtin.unarchive:
        src: /tmp/awscliv2.zip
        dest: /tmp
        remote_src: yes

    - name: Install AWS CLI v2
      ansible.builtin.command: /tmp/aws/install
      args:
        creates: /usr/local/bin/aws

    # ---------------- Kubectl ----------------
    - name: Download kubectl v1.31.1
      ansible.builtin.get_url:
        url: https://dl.k8s.io/release/v1.31.1/bin/linux/amd64/kubectl
        dest: /usr/local/bin/kubectl
        mode: '0755'

    # ---------------- Python Virtualenv ----------------
    - name: Create Python virtualenv
      ansible.builtin.command:
        cmd: python3 -m venv "{{ ansible_venv_path }}"
        creates: "{{ ansible_venv_path }}"

    - name: Upgrade pip in virtualenv
      ansible.builtin.command:
        cmd: "{{ ansible_venv_path }}/bin/pip install --upgrade pip setuptools wheel"

    - name: Install Python Kubernetes dependencies
      ansible.builtin.pip:
        name:
          - kubernetes
          - openshift
          - pyyaml
        virtualenv: "{{ ansible_venv_path }}"

    # ---------------- AWS credentials ----------------
    - name: Create AWS config directory
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/.aws
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0700'

    - name: Set AWS credentials
      ansible.builtin.template:
        src: templates/credentials.j2
        dest: /home/{{ ansible_user }}/.aws/credentials
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

    - name: Set AWS config
      ansible.builtin.template:
        src: templates/config.j2
        dest: /home/{{ ansible_user }}/.aws/config
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

    # ---------------- Kubeconfig ----------------
    - name: Ensure .kube directory exists
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/.kube
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Generate kubeconfig from AWS EKS
      ansible.builtin.command: >
        aws eks update-kubeconfig
        --name {{ EKS_CLUSTER_NAME }}
        --region {{ AWS_DEFAULT_REGION }}
        --kubeconfig /home/{{ ansible_user }}/.kube/config
      args:
        creates: /home/{{ ansible_user }}/.kube/config
      environment:
        HOME: /home/{{ ansible_user }}
      become_user: "{{ ansible_user }}"

    - name: Ensure kubeconfig permissions
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/.kube/config
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
